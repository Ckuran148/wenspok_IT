<!-- Place this where you want the checklist names to appear -->
<div id="remaining-checklists-container">
  <div id="loader-checklists" style="display:none">Loading…</div>
  <ul id="remaining-checklists"></ul>
</div>

<div id="remaining-checklists-container">
  <div id="loader-checklists" style="display:none">Loading…</div>
  <ul id="remaining-checklists"></ul>
</div>

<script>
  // --- CONFIG (use your Cloudflare worker endpoint and mode) ---
  const ENDPOINT = "https://jolt-proxy.ckuran.workers.dev";
  const HEADERS = { "Content-Type": "application/json" };

  // Use LOCATION mode with the location id you provided
  const MODE_DATA = { mode: "LOCATION", id: "TG9jYXRpb246MDAxY2U5MGEyNjYxOTU3NWQ1ZjI3YTc0M2IyNGI1OWY=" };

  // GraphQL query adapted from your sandbox (requests both instanceTitle and template.title)
  const QUERY = `
    query ListInstances($filter: ListInstancesFilter!, $mode: ModeInput) {
      listInstances(filter: $filter, mode: $mode) {
        id
        instanceTitle
        completionTimestamp
        listTemplate { title }
      }
    }
  `;

  // Compute local start/end epoch seconds for today
  function getTodayEpochWindowLocal() {
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
    const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
    return { start: Math.floor(start.getTime() / 1000), end: Math.floor(end.getTime() / 1000) };
  }

  async function renderChecklistNamesForToday() {
    const loader = document.getElementById('loader-checklists');
    const listEl = document.getElementById('remaining-checklists');
    loader.style.display = 'block';
    listEl.innerHTML = '';

    const { start, end } = getTodayEpochWindowLocal();

    // Build the filter exactly like your sandbox: incomplete, not sublists, deadline window
    const filter = {
      deadlineAfterTimestamp: start,
      deadlineBeforeTimestamp: end,
      completionStatus: "INCOMPLETE",
      isSublist: false
    };

    const variables = { filter, mode: MODE_DATA };

    try {
      const res = await fetch(ENDPOINT, {
        method: "POST",
        headers: HEADERS,
        body: JSON.stringify({ query: QUERY, variables })
      });

      const payload = await res.json();
      console.log('listInstances payload', payload); // inspect raw response in DevTools

      if (!payload || payload.errors) {
        console.error('GraphQL error', payload.errors || payload);
        listEl.innerHTML = '<li class="err">Error loading checklists</li>';
        return;
      }

      const lists = payload.data.listInstances || [];
      // Filter out any that are completed (safety check)
      const remaining = lists.filter(l => !l.completionTimestamp);

      if (remaining.length === 0) {
        listEl.innerHTML = '<li>No remaining checklists for today</li>';
        return;
      }

      // Render only the checklist name: prefer instanceTitle, then template.title
      remaining.forEach(l => {
        const name = (l.instanceTitle && l.instanceTitle.trim()) ||
                     (l.listTemplate && l.listTemplate.title && l.listTemplate.title.trim()) ||
                     `Checklist ${l.id}`;

        const li = document.createElement('li');
        li.textContent = name;
        listEl.appendChild(li);
      });
    } catch (err) {
      console.error(err);
      listEl.innerHTML = '<li class="err">Request failed</li>';
    } finally {
      loader.style.display = 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', renderChecklistNamesForToday);
</script>
